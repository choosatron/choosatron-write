angular.module("storyApp.filters",[]),angular.module("storyApp.directives",[]),angular.module("storyApp.utils",[]),angular.module("storyApp.storage",["storyApp.utils"]),angular.module("storyApp.databridge",["storyApp.storage"]),angular.module("storyApp.models",["storyApp.utils"]),angular.module("storyApp.translators",["storyApp.utils","storyApp.models"]),angular.module("storyApp.controllers",["storyApp.models","storyApp.databridge","storyApp.translators"]),angular.module("storyApp",["storyApp.filters","storyApp.directives","storyApp.controllers","ngAnimate","ngRoute","ui.utils"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/stories",{templateUrl:"templates/stories.html",controller:"StoriesCtrl"}),$routeProvider.when("/playback",{templateUrl:"templates/playback.html",controller:"PlaybackCtrl"}),$routeProvider.when("/story",{templateUrl:"templates/passage.html",controller:"StoryCtrl"}),$routeProvider.when("/profiles",{templateUrl:"templates/profiles.html",controller:"ProfilesCtrl"}),$routeProvider.otherwise({redirectTo:"/stories"})}]),angular.module("storyApp.directives").directive("confirmClick",["$parse",function($parse){return{compile:function($templateElement,$templateAttributes){var fn=$parse($templateAttributes.confirmClick);return function($scope,$element,attrs){$element.on("click",function(){$("#confirmDelete").off("click.confirmed"),$("#confirmDelete").one("click.confirmed",function(evt2){$scope.$apply(function(){fn($scope,{$event:evt2})})}),$("#confirmModal .confirm_message").html(attrs.confirmMessage),$("#confirmModal").modal("show")})}}}}]).directive("passageIcons",function(){return{compile:function(){return function($scope,$element,attrs){$scope.$watch(attrs.passageIcons,function(){var passage=$scope.$eval(attrs.passageIcons);if(passage){var choices=passage.choices?passage.choices.length:0,verb="Links to ",noun="a passage with ",count="";count=0==choices?" no choices.":1==choices?" one choice.":choices+" choices",passage.has_append()&&(subject="Appends to ",choices="a"),passage.has_ending()?($element.attr("data-ending",passage.ending_value),noun="an ending passage with "):$element.removeAttr("data-ending");var direction=$element.hasClass("passageBack")?"left":"right";$element.attr("data-choices",choices),$element.attr("data-toggle","tooltip"),$element.attr("data-placement","auto "+direction),$element.attr("title",verb+noun+count),$element.tooltip({container:"body"})}},!0)}}}}),angular.module("storyApp.filters").filter("truncate",function(){return function(text,length){return isNaN(length)&&(length=100),text&&text.length<=length?text:String(text).slice(0,length)}}).filter("quote",function(){return function(text){return text&&text.match(/Unwritten/)?text:'"'+text+'"'}}),angular.module("storyApp.controllers").controller("PlaybackCtrl",["$scope","$location","$profiles","$translators","Playback",function($scope,$location,$profiles,$translators,Playback){$scope.playback=null,$scope.story=null,$scope.passage=null,$profiles.load().then(function(){var profile=$profiles.current,entry=profile.entries[0];$translators.restore("json",entry.entry_id).then(function(result){$scope.story=result.story,$scope.playback=new Playback,$scope.passage=$scope.playback.start(result.story)})}),$scope.show_stories_menu=function(){$location.path("stories")},$scope.clear_passage_search=function(){$scope.passage_search=""},$scope.select_choice=function(choice){$scope.passage=$scope.playback.select(choice),$scope.playback.debug()},$scope.select_passage=function(passage){$selection.setPassage(passage)},$scope.edit_story=function(){$location.path("story")}}]),angular.module("storyApp.controllers").controller("ProfileCtrl",["$scope","$location","$profiles",function($scope,$location,$profiles){$profiles.load().then(function(){$scope.profiles=$profiles}),$scope.view=function(){$location.path("profiles")}}]).controller("ProfilesCtrl",["$scope","$location","$profiles","Profile",function($scope,$location,$profiles,Profile){$scope.saveState="disk",$profiles.load().then(function(){$scope.profiles=$profiles,$scope.$watch("profiles.current.name",function(){$scope.saveState="save"})}),$scope.show_stories_menu=function(){$location.path("stories")},$scope.new_profile=function(){var profile=new Profile;$profiles.select(profile)},$scope.pick_profile=function(profile){$profiles.select(profile),$profiles.save()},$scope.save_profile=function(){$profiles.save().then(function(){$scope.saveState="saved"})}}]),angular.module("storyApp.controllers").controller("StoriesCtrl",["$scope","$location","$profiles","$file","$translators","Story",function($scope,$location,$profiles,$file,$translators,Story){$scope.profile=null,$scope.stories_sort="modified",$scope.stories_sort_desc=!0,$scope.exporters=$translators.exporters(),$scope.importers=$translators.importers(),$profiles.load().then(function(){return $profiles.current?void($scope.profile=$profiles.current):$location.path("profiles")}),$scope.sort_stories=function(sort){$scope.stories_sort==sort?$scope.stories_sort_desc=!$scope.stories_sort_desc:($scope.stories_sort=sort,$scope.stories_sort_desc=!1)},$scope.new_story=function(){var story=new Story,err=function(e){console.error("Error creating story",e)};$file.create("json").then(function(entry){story.title=entry.name.substr(0,entry.name.lastIndexOf(".")),story.author=$profiles.current.name,$file.write(entry,story.serialize()).then(function(){var entryId=$file.getEntryId(entry);$scope.profile.save_entry(entryId,story),$profiles.save().then(function(){$location.path("story")},err)},err)},err)},$scope.edit_story=function(entry){$profiles.current.select_entry(entry),$profiles.save().then(function(){$location.path("story")})},$scope.delete_story=function(entry){$profiles.current.remove_entry(entry),$profiles.save()},$scope.duplicate_story=function(entry){var title="Copy of "+entry.title,copyOriginal=function(copy){if(copy){var copyId=$file.getEntryId(copy);$translators.restore("json",entry.entry_id).then(function(result){result.story.title=title,$profiles.current.save_entry(copyId,result.story),$file.write(copy,result.story.serialize()).then(function(){$profile.save()})})}};$file.create("json",title).then(copyOriginal)},$scope.export_story=function(type,story){$translators.export(type,story)},$scope.import_story=function(type){$translators.import(type).then(function(result){if(console.debug("Imported result",result),result&&result.entry&&result.story){var story=result.story;$file.create("json").then(function(newFile){newFile&&$file.write(newFile,story.serialize()).then(function(){var newFileId=$file.getEntryId(newFile),entry=$profiles.current.save_entry(newFileId,story);$scope.edit_story(entry)})})}})}}]),angular.module("storyApp.controllers").controller("StoryCtrl",["$scope","$location","$timeout","$profiles","$translators","FileEntryAutoSave","Passage","Choice","Command","Operators","Genres",function($scope,$location,$timeout,$profiles,$translators,FileEntryAutoSave,Passage,Choice,Command,Operators,Genres){function loadVariables(){var cmds=$scope.story.collect_commands(),vars=[];cmds.forEach(function(cmd){vars.push(cmd.variable)}),$scope.variables=angular.toJson(vars)}function autosave(result){var saver=$scope.saver=new FileEntryAutoSave(result.story.id,result.entry,$scope),getStoryId=function(s){return s&&s.id},getStoryForSave=function(s){return s?($timeout(function(){s.modified=Date.now()}),s.object()):null};$profiles.current.autosave?saver.watch("story",getStoryId,getStoryForSave):$scope.$watch("story",function(nv,ov){nv!==ov&&($scope.save_state="floppy-save")},!0),saver.onSaving(function(){$scope.save_state="transfer"}),saver.onThrottling(function(){$scope.save_state="transfer"}),saver.onSaved(function(){$timeout(function(){$scope.$apply(function(){$scope.save_state="floppy-disk"})},250)}),saver.onError(function(e){$scope.save_state="floppy-remove",console.error("Error autosaving story",e)})}$scope.entry=null,$scope.story=null,$scope.passage=null,$scope.profiles=$profiles,$scope.variables=[],$scope.operators=Operators,$scope.genres=Genres,$scope.exporters=$translators.exporters(),$scope.alerts=[],$scope.prev_passage=null,$scope.picking=!1,$scope.deleted=null,$scope.modal={confirm_message:""},$scope.show_story_details=!1,$scope.show_passages=!1,$scope.save_state="floppy-disk",$scope.exit_change_modal={},$profiles.load().then(function(){var profile=$profiles.current;if(!profile)return console.error("No profiles selected. Redirecting to ./profiles"),$location.path("profiles");var entries=profile.entries;if(!entries||0==entries.length)return console.error("Profile has no entries. Redirecting to ./stories"),$location.path("stories");var entry=entries[0],entryId=entry.entry_id;if(!entryId)return console.error("No entry id found for entry. Redirecting to ./stories"),$location.path("stories");var onFail=function(e){return console.error("Error restoring story",e),$location.path("stories")};$scope.entry=entry,$translators.restore("json",entryId).then(function(result){return result&&result.story?($scope.story=result.story,$scope.passage=result.story.get_opening(),$scope.show_story_details=result.story.passages.length<2,loadVariables(),$profiles.current.save_entry(entryId,result.story),$profiles.save(),void autosave(result)):$location.path("stories")},onFail)}),$scope.playback_story=function(){$location.path("playback")},$scope.show_stories_menu=function(){$location.path("stories")},$scope.new_passage=function(entrance_choice){$scope.passage=new Passage,$scope.passage.number=$scope.story.get_next_passage_number(),$scope.story.add_passage($scope.passage),entrance_choice&&entrance_choice.set_destination($scope.passage),$scope.picking=null},$scope.pick_passage=function(choice){$scope.picking=choice},$scope.get_passage=function(id){return $scope.story?$scope.story.get_passage(id):null},$scope.valid_picking_option=function(item){return!$scope.picking||"append"!=$scope.passage.exit_type||$scope.passage!=item},$scope.select_passage=function(id){$scope.picking?($scope.picking.set_destination($scope.story.get_passage(id)),$scope.picking=null):$scope.edit_passage(id)},$scope.edit_passage=function(id){$scope.set_passage($scope.story.get_passage(id))},$scope.set_passage=function(passage,reset){$(".scrollPassages").scrollTop(0),$scope.prev_passage=reset?null:$scope.passage,$scope.passage=passage},$scope.delete_passage=function(passage){console.info("deleting",passage),$scope.deleted={type:"passage",title:passage.content,undo:function(){passage.trashed=!1,$scope.story.add_passage(passage),$scope.passage=passage}},$scope.story.delete_passage(passage.id);var previous=$scope.prev_passage||$scope.story.get_opening();$scope.set_passage(previous,!0)},$scope.confirm_exit_type_change=function(passage,exit_type){var alert,message,onConfirm;if(passage.exit_type!=exit_type){if(passage.exit_is_empty())return void passage.set_exit_type(exit_type);switch(passage.exit_type){case"ending":alert="This passage's ending value will be deleted.";break;case"append":alert="This passage's append will be deleted.";break;case"choices":alert="This passage's choices will be deleted."}switch(message="A passage can only have one type of exit.  ",exit_type){case"ending":message+="Are you sure you want to change this passage to an ending?";break;case"append":message+="Are you sure you want to change this passage to have an append?";break;case"choices":message+="Are you sure you want to change this passage to have choices?"}$scope.exit_change_modal.alert=alert,$scope.exit_change_modal.message=message,onConfirm=function(){$scope.$apply(function(){passage.set_exit_type(exit_type)})},$("#confirmExit").off("click.confirmed"),$("#confirmExit").one("click.confirmed",onConfirm),$("#exitChangeConfirmModal").modal("show")}},$scope.new_choice=function(passage){var choice=new Choice;passage.add_choice(choice)},$scope.has_destination=function(choice){return choice.has_destination()},$scope.delete_choice=function(passage,choice){$scope.deleted={type:"choice",title:choice.content,undo:function(){$scope.passage.add_choice(choice)}},passage.remove_choice(choice)},$scope.delete_choice_update=function(choice,update){choice.updates=choice.updates.filter(function(u){return u.raw!=update.raw})},$scope.delete_choice_condition=function(choice){choice.condition=new Command,choice.showCondition=!1},$scope.add_choice_update=function(choice){choice.updates.push(new Command)},$scope.clear_passage_search=function(){$scope.passage_search=""},$scope.undo_delete=function(){$scope.deleted&&($scope.deleted.undo(),$scope.deleted=null)},$scope.json_story=function(pretty){return $scope.story?$scope.story.serialize(pretty):"{}"},$scope.export_story=function(type){$translators.export(type,$scope.story)}}]),angular.module("storyApp.databridge").service("$profiles",["ChromeStorageEngine","Storage","Profile","$q",function(LocalStorageEngine,Storage,Profile,$q){var storageEngine=new LocalStorageEngine,profileStorage=new Storage(storageEngine,"choosatron");this.loaded=!1,this.all=[],this.current=null,this.save=function(){return profileStorage.set("profiles",this.all)},this.select=function(profile){for(var i=0;i<this.all.length;i++)this.all[i].id==profile.id&&this.all.splice(i,1);return this.all.unshift(profile),this.current=profile,this.save()},this.load=function(){var deferred=$q.defer();if(this.loaded)return deferred.resolve(),deferred.promise;var setAll=function(list){list||(list=[]),list.forEach(function(data,i){list[i]=new Profile(data)}),this.loaded=!0,this.all=list,this.current=this.all[0],deferred.resolve(this)};return profileStorage.get("profiles").then(setAll.bind(this)),deferred.promise}}]),angular.module("storyApp.models").factory("Choice",["Model","Command",function(Model,Command){function Choice(data){this.content="",this.showCondition=!1,this.showUpdates=!1,this.condition=new Command,this.destination=null,this.updates=[],Model.call(this,data)}return Choice.methods={get_content:function(){return this.content||"Unwritten Choice"},has_destination:function(passage){return"undefined"==typeof passage?this.destination:passage&&passage.id&&passage.id==this.destination},set_destination:function(passage){this.destination=passage&&passage.id},add_update:function(update){this.updates.push(new Command(update))},load_updates:function(updates){this.updates=[];for(var i=0;i<updates.length;i++){var update=new Command(updates[i]);this.updates.push(update)}this.showUpdates=this.updates.length>0},load_condition:function(condition){this.condition=new Command(condition),this.showCondition=condition&&condition.length}},Model.extend(Choice,Choice.methods),Choice}]),angular.module("storyApp.models").factory("Command",["Model","Operator",function(Model,Operator){function Command(data){this.variable=null,this.verb=null,this.value=null,Object.defineProperty(this,"raw",{get:function(){return this.variable+" "+this.verb+" "+this.value},set:function(str){this.parse(str)}}),Model.call(this,data)}return Command.methods={parse:function(str){this.raw=str;var parts=ptn.exec(str);return parts.length<4?!1:(this.variable=parts[1],this.verb=parts[2],this.value=parts[3],!0)},empty:function(){return!this.variable||!this.verb||!this.value},cast:function(v){var f=parseFloat(v);if(!isNaN(f))return f;var i=parseInt(v);return isNaN(i)?v:i},apply:function(source){var func=Operator[this.verb];if(func&&func.action){var data=this.cast(source[this.variable]||0),value=this.cast(this.value);source[this.variable]=func.action(data,value)}return source[this.variable]},test:function(source){var func=Operator[this.verb];if(func&&func.action){var data=this.cast(source[this.variable]||0),value=this.cast(this.value);return func.action(data,value)}return!1}},Model.extend(Command,Command.methods),Command}]),angular.module("storyApp.models").value("Genres",["Action","Adventure","Comedy","Crime","Erotica","Faction","Fantasy","Historical","Horror","Mystery","Paranoid","Philosophical","Political","Romance","Saga","Satire","Science Fiction","Slice of Life","Speculative","Thriller","Urban"]),angular.module("storyApp.models").factory("Model",["Random",function(Random){function Model(data){this.id=Random.id(),this.created=Date.now(),this.modified=null,this.opened=null,data&&this.load(data)}return Model.abbrs=[],Model.extend=function(cls,data){cls.prototype=new Model,cls.constructor=cls,angular.forEach(data,function(func,name){cls.prototype[name]=func})},Model.prototype={load:function(data){for(var key in data){var loader="load_"+key;"function"==typeof this[loader]?this[loader](data[key]):this[key]=data[key]}},each:function(field,callback){var list=this[field];if(!list)return this;for(var item,i=0;item=list[i];i++){var stop=callback(item);if(stop===!1)break}return this},refresh_id:function(){this.id=Random.id()},object:function(){var o={};for(var key in this){var val=this[key];o[key]=val instanceof Model?val.serialize():val}return o},serialize:function(pretty){var o=this.object(),s=angular.toJson(o,pretty);return s}},Model}]),angular.module("storyApp.models").service("Operator",function(){return{"==":{name:"equals",type:"condition",action:function(a,b){return a==b}},"!=":{name:"not equals",type:"condition",action:function(a,b){return a!=b}},">":{name:"greater than",type:"condition",action:function(a,b){return a>b}},">=":{name:"greater than or equal to",type:"condition",action:function(a,b){return a>=b}},"<":{name:"less than",type:"condition",action:function(a,b){return b>a}},"<=":{name:"less than or equal to",type:"condition",action:function(a,b){return b>=a}},"=":{name:"set to",type:"update",action:function(a,b){return b}},"+=":{name:"increase by",type:"update",action:function(a,b){return a+b}},"-=":{name:"subtract by",type:"update",action:function(a,b){return a-b}},"*=":{name:"multiply by",type:"update",action:function(a,b){return a*b}},"/=":{name:"divide by",type:"update",action:function(a,b){return a/b}}}}).service("Operators",["Operator",function(Operator){var Operators=[];return Operator.keywords=Object.keys(Operator),Operator.keywords.forEach(function(key){var op=Operator[key];op.keyword=key,Operators.push(op)}),Object.defineProperty(Operators,"conditions",{get:function(){return this.filter(function(o){return"condition"==o.type})}}),Object.defineProperty(Operators,"updates",{get:function(){return this.filter(function(o){return"update"==o.type})}}),Operators}]),angular.module("storyApp.models").factory("Passage",["Model","Choice",function(Model,Choice){function Passage(data){this.number=null,this.content="",this.choices=[],this.opening=!1,this.value=0,this.ending_value=!1,this.trashed=!1,this.append_link=new Choice,Model.call(this,data),this.reinit(),Passage.passages[this.id]=this,Object.defineProperty(this,"abbr",{get:function(){return this.abbreviate(10)}})}return Passage.abbrs={},Passage.passages={},Passage.methods={reinit:function(){this.exit_type=this.has_ending()?"ending":this.has_append()?"append":"choices"},get_content:function(){return this.content||"Unwritten Passage"},set_exit_type:function(exit_type){this.ending_value=!1,this.choices=[],this.append_link=new Choice,this.exit_type=exit_type},exit_is_empty:function(){return"ending"==this.exit_type&&!this.has_ending()||"append"==this.exit_type&&!this.has_append()||"choices"==this.exit_type&&!this.has_choices()},has_ending:function(){return this.ending_value!==!1},has_append:function(passage){return passage?this.append_link.has_destination(passage):this.append_link&&this.append_link.has_destination&&this.append_link.has_destination()},has_choices:function(){return this.choices&&this.choices.length},set_ending:function(val){this.ending_value=val},ending_type_name:function(){if(!this.has_ending())return"";switch(this.ending_value){case-2:return"terrible";case-1:return"bad";case 0:return"neutral";case 1:return"good";case 2:return"great"}return""},abbreviate:function(len){for(var starter=this.content.replace(/[^a-zA-Z0-1]/g,"").substr(0,len).toLowerCase(),abbr=starter,i=1;Passage.abbrs[abbr]&&Passage.abbrs[abbr]!=this.id;)abbr=starter+(i++).toString();return Passage.abbrs[abbr]=this.id,abbr},add_choice:function(choice){return this.choices.push||(this.choices=[]),this.choices.push(choice),choice.id},remove_choice:function(choice){for(var c,i=0;c=this.choices[i];i++)if(c.id==choice.id){this.choices.splice(i,1);break}},get_choice:function(id){if(!this.choices)return null;var choice=null,found=this.choices.some(function(c){return c.id==id?(choice=c,!0):!1});return!found&&this.has_append()&&this.append_link.id==id&&(choice=this.append_link),choice},has_destination:function(passage){var has=!1;return this.each_choice(function(c){return c.has_destination(passage)?(has=!0,!1):void 0}),has},get_destinations:function(){var ids=[];return this.each_choice(function(c){c.each_path(function(p){ids.indexOf(p.destination)<0&&ids.push(p.destination)})}),ids},get_passage_choice:function(passage){var matching_choice,n=1;return this.each_choice(function(choice){choice.has_destination(passage)&&(matching_choice=n+". "+choice.get_content()),n++}),matching_choice},each_choice:function(callback){return this.each("choices",callback)},load_choices:function(choices){for(var i=0;i<choices.length;i++)this.choices.push(new Choice(choices[i]))},load_append_link:function(append_link){this.append_link=new Choice(append_link)}},Model.extend(Passage,Passage.methods),Passage}]),angular.module("storyApp.models").factory("Playback",["Model",function(Model){function Playback(data){this.story=null,this.sandbox={},this.selected=[],Model.call(this,data)}return Playback.methods={start:function(story){this.story=story;var opening=story&&story.get_opening();return this.trim(opening),opening},trim:function(passage){if(passage&&passage.choices){var self=this;passage.choices.forEach(function(c){c.hidden=c.condition&&!c.condition.empty()&&!c.condition.test(self.sandbox)})}},select:function(choice){var choice=choice&&choice.id?this.story.get_choice(choice.id):choice;if(!choice)return null;var self=this;if(this.selected.push(choice.id),choice.updates.forEach&&choice.updates.forEach(function(u){u.apply(self.sandbox)}),!choice.has_destination())return null;var next=this.story.get_passage(choice.destination);return this.trim(next),next},debug:function(){var data=[],keys=Object.keys(this.sandbox),sb=this.sandbox;keys.forEach(function(key){data.push({name:key,value:sb[key]})}),console.table(data)}},Model.extend(Playback,Playback.methods),Playback}]),angular.module("storyApp.models").factory("Profile",["Model",function(Model){function Profile(data){this.created=Date.now(),this.name="",this.autosave=!0,this.entries=[],Model.call(this,data)}return Profile.methods={save_entry:function(entryId,story){var entry={entry_id:entryId,id:story.id},index=this.find_entry_index(entry);index>=0?(entry=this.entries[index],this.entries.splice(index,1),console.debug("Updating existing entry",entryId,entry,story)):console.debug("Adding new entry",entryId,entry,story);var types=["string","number","boolean"];for(var key in story){var value=story[key],type=typeof value;types.indexOf(type)<0||(entry[key]=value)}return this.entries.unshift(entry),entry},find_entry_index:function(entry){if(!entry)return-1;if(!this.entries||!this.entries.length)return-1;for(var i=0;i<this.entries.length;i++){var compared=this.entries[i];if(compared.entry_id==entry.entry_id)return i;if(compared.id==entry.id)return i}return-1},remove_entry:function(entry){var i=this.find_entry_index(entry);0>i||this.entries.splice(i,1)},select_entry:function(entry){var i=this.find_entry_index(entry);if(0>i)return null;var selected=this.entries[i];return this.entries.splice(i,1),this.entries.unshift(selected),selected}},Model.extend(Profile,Profile.methods),Profile}]),angular.module("storyApp.models").factory("Story",["Model","Passage",function(Model,Passage){function Story(data){this.lastPassageNumber=0,this.created=Date.now(),this.modified=Date.now(),this.title="",this.version=1,this.description="",this.cover_url="",this.genre="",this.author="",this.credit="",this.passages=[],Model.call(this,data)}return Story.methods={get_title:function(){return this.title||"Untitled Story"},get_next_passage_number:function(){return++this.lastPassageNumber},get_opening:function(){var opening=null;return this.each_passage(function(p){return p.opening?(opening=p,!1):void 0}),opening||(opening=new Passage,opening.opening=!0,this.add_passage(opening)),opening},get_orphans:function(){var destinations=[];this.each_passage(function(p){destinations.concat(p.get_destinations())});return this.each_passage(function(p){destinations.indexOf(p.id)<0&&orphans.push(p)}),p},get_choice:function(id){var choice=null;return this.passages.some(function(p){var c=p.get_choice(id);return c?(choice=c,!0):!1}),choice},add_passage:function(passage){return 0==this.passages.length&&(passage.opening=!0),this.passages.push(passage),passage.id},delete_passage:function(id){if(this.passages)for(var i=0;i<this.passages.length;i++)if(this.passages[i].id==id){this.passages[i].trashed=!0,this.passages.splice(i,1);break}},get_passage:function(id){var passage=null;return this.passages.some(function(p){return p.id==id?(passage=p,!0):!1}),passage},each_passage:function(callback){return this.each("passages",callback)},collect_entrances:function(passage){var entrances=[];return this.each_passage(function(p){p.has_destination(passage)&&entrances.push(p),p.has_append(passage)&&entrances.push(p)}),entrances},collect_commands:function(){function add(cmd){cmd.empty()||cmds.push(cmd)}var cmds=[];return this.each_passage(function(p){p.each_choice(function(c){add(c.condition),c.updates.forEach(add)})}),console.debug("FOUND",cmds),cmds},load_passages:function(passages){var i;for(i=0;i<passages.length;i++)this.passages.push(new Passage(passages[i]));for(i=0;i<this.passages.length;i++)this.passages[i].reinit()}},Model.extend(Story,Story.methods),Story}]),angular.module("storyApp.storage").factory("AutoSave",["$timeout","EventHandler",function($timeout,EventHandler){return function($storage,$scope){var events=EventHandler.create("error","saving","saved","throttling");events.async=!0,events.context=this,$storage.on("error",function(e){events.fire("error",e)});var throttle=$storage.engine.throttle||6e3,lastSave={},savePromise={};this.onSaving=function(callback){events.on("saving",callback)},this.onThrottling=function(callback){events.on("throttling",callback)},this.onSaved=function(callback){events.on("saved",callback)},this.onError=function(callback){events.on("error",callback)},this.save=function(key,val){if(key){savePromise[key]&&$timeout.cancel(savePromise[key]);var doSave=function(){events.fire("saving",key,val),$storage.set(key,val).then(function(){events.fire("saved",key,val),lastSave[key]=Date.now()})},lastTimeSave=lastSave[key];return lastTimeSave&&Date.now()-lastTimeSave<throttle?(events.fire("throttling",key,throttle),void(savePromise[key]=$timeout(doSave,throttle))):void doSave()}},this.watch=function(modelName,getKey,getValue){var save=this.save.bind(this);$scope.$watch(modelName,function(nv,ov){if(nv!==ov){var key=getKey?getKey(nv):modelName,val=getValue?getValue(nv):nv;save(key,val)}},!0)}}}]),angular.module("storyApp.storage").factory("BaseStorageEngine",["$q",function($q){return function(){this.area={},this.throttle=100,this.toJson=function(o){return angular.toJson(o)},this.fromJson=function(s){try{return angular.fromJson(s)}catch(e){return console.error("Error decoding data",e),null}},this.getItem=function(namespace,key){var deferred=$q.defer(),value=this.area[namespace];return key&&(value=value&&value[key]),deferred.resolve(value),deferred.promise},this.setItem=function(namespace,key,value){var deferred=$q.defer();return this.area[namespace]||(this.area[namespace]={}),this.area[namespace][key]=value,deferred.resolve(value),deferred.promise},this.deleteItem=function(namespace,key){var deferred=$q.defer();return this.area[namespace]&&delete this.area[namespace][key],deferred.resolve(),deferred.promise}}}]).factory("FileSystemStorageEngine",["$q","BaseStorageEngine","$file",function($q,BaseStorageEngine,$file){return function(extensions,type){BaseStorageEngine.call(this,$q),this.extensions=extensions,this.type=type,this.throttle=1e3,this.area={},this.getEntry=function(namespace,key){var deferred=$q.defer(),self=this;if(this.area[namespace]||(this.area[namespace]={}),!key)return deferred.resolve(this.area[namespace]),deferred.promise;var entry=key&&this.area[namespace][key];return"object"==typeof entry?deferred.resolve(entry):entry?$file.restore(entry).then(function(entry){self.area[namespace][key]=entry,deferred.resolve(entry)},function(){delete self.area[namespace][key],self.getEntry(namespace,key).then(deferred.resolve,deferred.reject)}):$file.open(this.extensions).then(function(entry){self.area[namespace][key]=entry,deferred.resolve(entry)},deferred.reject),deferred.promise},this.getItem=function(namespace,key){var deferred=$q.defer(),self=this;return this.getEntry(namespace,key).then(function(entry){"FileEntry"==typeof entry?$file.read(entry).then(function(text){deferred.resolve(self.fromJson(text))},deferred.reject):deferred.resolve(entry)},deferred.reject),deferred.promise},this.setItem=function(namespace,key,value){var deferred=$q.defer(),self=this;return value=this.toJson(value),this.getEntry(namespace,key).then(function(entry){$file.write(entry,value,self.type).then(deferred.resolve,deferred.reject)},deferred.reject),deferred.promise},this.deleteItem=function(){throw new Error("Cannot delete items in the filesystem")}}}]).factory("LocalStorageEngine",["$q","BaseStorageEngine",function($q,BaseStorageEngine){return function(){BaseStorageEngine.call(this,$q),this.area=window.localStorage,this.getItem=function(namespace,key){var deferred=$q.defer(),self=this,result=this.area.getItem(namespace);if(key){var value=result&&result[key];deferred.resolve(self.fromJson(value))}else deferred.resolve(self.fromJson(result));return deferred.promise},this.setItem=function(namespace,key,value){var deferred=$q.defer(),self=this;return this.getItem(namespace).then(function(data){data[key]=value,self.area.setItem(namespace,self.toJson(data)),deferred.resolve(value)},deferred.reject),deferred.promise},this.deleteItem=function(namespace,key){var deferred=$q.defer(),self=this;return this.getItem(namespace).then(function(data){data&&(delete data[key],self.area.setItem(namespace,self.toJson(data))),deferred.resolve()},deferred.reject),deferred.promise}}}]).factory("ChromeStorageEngine",["$q","BaseStorageEngine",function($q,BaseStorageEngine){return function(){BaseStorageEngine.call(this,$q),this.area=chrome.storage.local,this.getItem=function(namespace,key){var deferred=$q.defer(),self=this,cb=function(items){if(chrome.runtime.lastError)return deferred.reject(chrome.runtime.lastError);var data=self.fromJson(items[namespace]);deferred.resolve(key?data&&data[key]:data)};return this.area.get(namespace,cb),deferred.promise},this.setItem=function(namespace,key,value){var deferred=$q.defer(),self=this;return this.getItem(namespace).then(function(items){if(chrome.runtime.lastError)return deferred.reject(chrome.runtime.lastError);items||(items={}),items[key]=value;var data={};data[namespace]=self.toJson(items),self.area.set(data,function(){return chrome.runtime.lastError?deferred.reject(chrome.runtime.lastError):void deferred.resolve(value)})},deferred.reject),deferred.promise},this.deleteItem=function(namespace,key){var deferred=$q.defer(),self=this;return this.getItem(namespace).then(function(items){if(chrome.runtime.lastError)return deferred.reject(chrome.runtime.lastError);if(!items)return deferred.resolve();delete items[key];var data={};data[namespace]=self.toJson(data),self.area.set(data,function(){return chrome.runtime.lastError?deferred.reject(chrome.runtime.lastError):void deferred.resolve()})},deferred.reject),deferred.promise}}}]).factory("ChromeSyncStorageEngine",["$q","ChromeStorageEngine",function($q,ChromeStorageEngine){return function(){ChromeStorageEngine.call(this,$q),this.area=chrome.storage.sync,this.throttle=6e3
}}]),angular.module("storyApp.storage").factory("FileEntryAutoSave",["AutoSave","Storage","FileSystemStorageEngine",function(AutoSave,Storage,FileSystemStorageEngine){function FileEntryAutoSave(id,entry,$scope){engine.area[namespace][id]=entry,AutoSave.call(this,storage,$scope)}var namespace="autosave",engine=new FileSystemStorageEngine;engine.area[namespace]={};var storage=new Storage(engine,namespace);return FileEntryAutoSave.prototype=Object.create(AutoSave.prototype),FileEntryAutoSave.prototype.constructor=FileEntryAutoSave,FileEntryAutoSave}]),angular.module("storyApp.storage").factory("Storage",["EventHandler",function(EventHandler){return function(engine,namespace){this.engine=engine,this.namespace=namespace,this.events=EventHandler.create("set","get","delete","error"),this.on=function(events,callback){this.events.on(events,callback)},this.data=function(){if(!this.engine)return null;var ns=this.namespace,self=this,err=function(e){self.events.fire("error",e)};switch(arguments.length){case 1:var key=arguments[0],got=function(item){return self.events.fire("get",item),item};return this.engine.getItem(ns,key).then(got,err);case 2:var key=arguments[0],val=arguments[1],saved=function(){self.events.fire("set",ns,key,val)};return null!==val?this.engine.setItem(ns,key,val).then(saved,err):this.engine.deleteItem(ns,key).then(saved,err);default:var got=function(item){return self.events.fire("get",item),item};return this.engine.getItem(ns).then(got,err)}},this.keys=function(){return this.data().then(function(data){if(!data)return[];var keys=[];for(var key in data)keys.push(key);return keys})},this.values=function(){return this.data().then(function(data){if(!data)return[];var values=[];for(var key in data)values.push(data[key]);return values})},this.set=function(key,data){return this.data(key,data)},this.get=function(key){return this.data(key)},this.remove=function(key){return this.data(key,null)}}}]),angular.module("storyApp.translators").service("ChoosatronTranslator",["Story","Passage","Choice",function(){return{type:"bin",name:"Choosatron File",datatype:"application/octet-stream",importMenuTitle:"Import from Choosatron File",imports:["cdam"],"import":function(){},exportMenuTitle:"Create a Choosatron File",exports:"cdam","export":function(){for(var buffer=new ArrayBuffer(100),uint16View=(new Uint8Array(buffer),new Uint16Array(buffer)),uint32View=new Uint32Array(buffer),i=0;i<uint32View.length;i++)uint32View[i]=2*i;for(var i=0;i<uint16View.length;i++)console.log("Entry "+i+": "+uint16View[i]),uint16View[i]=i;return buffer}}}]),angular.module("storyApp.translators").service("HtmlTranslator",["Story","$http",function(Story,$http){return{type:"html",name:"HTML",datatype:"text/html",exportMenuTitle:"Export to Web Page",exports:"html","export":function(story){var placeholder="{{STORY_JSON}}",json=angular.toJson(story);return $http.get("/templates/html.html").then(function(rsp){var html=rsp.data.replace(placeholder,json);return html})}}}]),angular.module("storyApp.translators").service("InkleTranslator",["Story",function(){return{type:"inkle",name:"Inkle",datatype:"text/javascript",importMenuTitle:"Import from Inkle File","import":function(){},exportMenuTitle:"Export to Inkle","export":function(){}}}]),angular.module("storyApp.translators").service("JsonTranslator",["Story",function(Story){return{type:"json",name:"JSON",datatype:"text/javascript",importMenuTitle:"Import from JSON",imports:["json"],"import":function(data){var json=angular.fromJson(data);return new Story(json)},exportMenuTitle:"Export to JSON",exports:"json","export":function(story){return story.serialize(!0)}}}]),angular.module("storyApp.translators").factory("$translators",["$file","$q","JsonTranslator","TwineTranslator","ChoosatronTranslator","InkleTranslator","HtmlTranslator",function($file,$q){var classes=Array.prototype.splice.call(arguments,2);return{all:function(){return classes},exporters:function(){return classes.filter(function(c){return c.exports&&c.exports.length})},importers:function(){return classes.filter(function(c){return c.imports&&c.imports.length})},get:function(type){return classes.find(function(c){return c.type==type?c:void 0})},read:function(type,entry){var deferred=$q.defer(),translator=this.get(type);return translator?(entry.id=$file.getEntryId(entry),$file.read(entry).then(function(data){var story=translator.import(data);story&&story.refresh_id();var result={story:story,entry:entry};deferred.resolve(result)},deferred.reject),deferred.promise):(deferred.reject(new Error("No translator for type: "+type)),deferred.promise)},restore:function(type,entryId){var deferred=$q.defer(),read=this.read.bind(this,type);return $file.restore(entryId).then(function(entry){read(entry).then(deferred.resolve,deferred.reject)},deferred.reject),deferred.promise},"import":function(type){var deferred=$q.defer(),translator=this.get(type),supported=translator.imports,read=this.read.bind(this);return $file.open(supported).then(function(entry){return entry?void read(type,entry).then(deferred.resolve,deferred.reject):deferred.resolve(null)},deferred.reject),deferred.promise},"export":function(type,story){var translator=this.get(type),extension=translator.exports,datatype=translator.datatype,data=translator.export(story);return data&&data.then?void data.then(function(rsp){$file.export(story.title,extension,rsp,datatype)}):$file.export(story.title,extension,data,datatype)}}}]),angular.module("storyApp.translators").service("TwineTranslator",["Story","Passage","Choice",function(Story,Passage,Choice){return{type:"twee",name:"Twine",importMenuTitle:"Import from Twine",imports:["txt","twee","tw"],"import":function(data){function fixPassage(passage){var contents=passage.content.split("\n"),content=null;for(passage.content="";contents.length;){content=contents.shift();var match=reChoice.exec(content);if(match){var choice=new Choice;choice.content=match[1],choice.destination=match[2],passage.add_choice(choice)}else passage.content+=content}}for(var lines=data.split("\n"),line="",reId=/:: (.+)/,reAttributes=/\s(\[([^\]\[]+)\])\s/,reChoice=/\[\[(.+)\|(.+)\]\]/,story=new Story,passage=null;lines.length;)if(line=lines.shift().trim(),line.length){var id=reId.exec(line);if(id)switch(id[1].trim()){case"StoryAuthor":story.author=lines.shift();break;case"StoryTitle":story.title=lines.shift();break;default:var passage=new Passage,content="",attrs=reAttributes.exec(id);for(passage.id=id[1].replace(reAttributes,"").trim(),attrs&&(passage.tags=attrs[1]);lines.length;){if(content=lines.shift().trim(),reId.test(content)){lines.unshift(content);break}passage.content+=content+"\n"}fixPassage(passage),story.add_passage(passage)}}return story},exportMenuTitle:"Export to Twine Format","export":function(){throw new Error("not implemented")}}}]),angular.module("storyApp.utils").service("EventHandler",["$timeout","$rootScope",function($timeout,$rootScope){function EventHandler(){this.listeners={},this.async=!1,this.context=null,this.register=function(names){for(var i=0;i<names.length;i++)this.listeners[names[i]]=[]},this.on=function(events,callback){var events=events.split(" "),self=this;events.forEach(function(event){self.listeners[event].push(callback)})},this.fire=function(event){if(!this.listeners[event])return void console.warn("Received unregistered event",event,ctx);var ctx=this.context||this,args=Array.prototype.splice.call(arguments,1),async=this.async,call=function(callback){async?$timeout(function(){$rootScope.$apply(function(){callback.apply(ctx,args)})}):callback.apply(ctx,args)};this.listeners[event].forEach(call)}}this.create=function(){var eh=new EventHandler;return arguments.length&&eh.register(arguments),eh}}]),angular.module("storyApp.utils").service("$file",["$q",function($q,fs,runtime){fs=fs||chrome.fileSystem,runtime=runtime||chrome.runtime;var tryResolve=function(deferred,data){runtime.lastError?deferred.reject(runtime.lastError):deferred.resolve(data)};this.getEntryId=function(entry){return fs.retainEntry(entry)},this.restore=function(entryId){var deferred=$q.defer();return fs.isRestorable(entryId,function(restorable){return restorable?void fs.restoreEntry(entryId,function(entry){tryResolve(deferred,entry)}):deferred.reject("Invalid entry id")}),deferred.promise},this.write=function(entry,data,type){var deferred=$q.defer();return type=type||"text/plain",entry.createWriter(function(writer){var blob=new Blob([data]);writer.onerror=deferred.reject,writer.onwriteend=function(event){return writer.length==blob.size?deferred.resolve(event):void writer.write(blob,{type:type})},writer.truncate(0)},deferred.reject),deferred.promise},this.read=function(entry){var deferred=$q.defer(),reader=new FileReader;return reader.onload=function(data){deferred.resolve(data.target&&data.target.result)},reader.onerror=function(e){deferred.reject(e)},entry.file(function(file){reader.readAsText(file)},deferred.reject),deferred.promise},this.choose=function(args){var deferred=$q.defer();return fs.chooseEntry(args,function(entry){tryResolve(deferred,entry)}),deferred.promise},this.create=function(extension,filename){var args={type:"saveFile"};return filename&&(args.suggestedName=filename),extension&&(args.accepts=[{extensions:[extension]}]),this.choose(args)},this.open=function(extensions){var args={type:"openFile"};return extensions&&(args.accepts=[{extensions:extensions}]),this.choose(args)},this.export=function(filename,extension,data,type){var deferred=$q.defer(),write=this.write,chosen=function(entry){return entry?runtime.lastError?deferred.reject(runtime.lastError):void write(entry,data,type).then(deferred.resolve,deferred.reject):deferred.resolve(null)},args={type:"saveFile",suggestedName:filename,accepts:[{extensions:[extension]}]};return fs.chooseEntry(args,chosen),deferred.promise}}]),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{enumerable:!1,configurable:!0,writable:!0,value:function(predicate){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof predicate)throw new TypeError("predicate must be a function");for(var value,list=Object(this),length=list.length>>>0,thisArg=arguments[1],i=0;length>i;i++)if(i in list&&(value=list[i],predicate.call(thisArg,value,i,list)))return value;return void 0}}),angular.module("storyApp.utils").service("Random",function(){this.defaultLen=10,this.used=[],this.candidates=[];for(var i=97;122>=i;i++)this.candidates.push(i);this.float=function(min,max){return Math.random()*(max-min)+max},this.int=function(min,max){return Math.floor(Math.random()*(max-min+1)+min)},this.id=function(len){len=len||this.defaultLen;var self=this,build=function(){for(var value="",i=0;len>i;i++)value+=self.char();return value},tries=0,value="";do value=build(),tries++;while(10*len>tries&&this.used.indexOf(value)>=0);return value},this.char=function(){var i=this.int(0,this.candidates.length-1),c=this.candidates[i];return String.fromCharCode(c)}}),angular.module("storyApp.utils").factory("Shared",["EventHandler",function(EventHandler){return function(){var events=EventHandler.create("get","set");events.context=this,this.data={},this.on=function(event,callback){events.on(event,callback)},this.get=function(callback){return callback&&callback(this.data),events.fire("get",this.data),this.data},this.set=function(value,callback){return this.data=value,events.fire("set",this.data),callback&&callback(this.data),this.data},this.clear=function(callback){this.data=null,events.fire("set",null),callback&&callback(null)}}}]);